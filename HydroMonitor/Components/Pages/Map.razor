@page "/viewMap"
@using HydroMonitor.Models
@using HydroMonitor.Repository
@using HydroMonitor.Services

@inject SensorDAO sensorDAO;
@inject SensorLocationDAO locationDAO;
@inject GeolocationService geoService;

<h3>Map</h3>
@if (!geoEnabled) {
    <div class="alert alert-warning">Location services are disabled. If you want to see your location on the map, please enable location services! </div>
}
<div class="alert alert-info">Displays a map of all the sensor locations.</div>
<div class="modal-content">
    <Image Src="/images/floorplandesign.jpg">
    </Image>
    @{
        var pinColour = "";
    }
    @foreach (var location in locationList)
    {
        switch (pinColour)
        { /*TODO: better system for colours*/
            case "":
                pinColour = "blue";
                break;
            case "blue":
                pinColour = "red";
                break;
            case "red":
                pinColour = "yellow";
                break;
            case "yellow":
                pinColour = "";
                break;
        }

        <MapMarker pinCoordinates="location.GetCoordinates()" pinColour="@(pinColour)"></MapMarker>
    }

    @if (geoEnabled)
    { //add an extra pin for the user's location
      <MapMarker pinCoordinates="getUserCoordinates()" pinColour="@(pinColour)"></MapMarker>
    }


</div>


@code {
    private readonly PeriodicTimer _periodicTimer = new(TimeSpan.FromSeconds(5));
    List<Sensor> sensorList;
    List<SensorLocation> locationList = new List<SensorLocation>();
    private Location userLocation;

    bool geoEnabled { get; set; }

    protected override async Task OnInitializedAsync()
    {
        this.sensorList = await sensorDAO.Load();
        foreach (var item in sensorList)
        {
            locationList.Add(await locationDAO.Load(item.SensorId));
        }
        if (await geoService.IsGeolocationEnabled())
        { // start the timer only if we can update the position
            geoEnabled = true;
            RunTimer();
        }
        StateHasChanged();
    }

    protected Tuple<double,double,double> getUserCoordinates()
    { //TODO: convert the user's coordinates into map coordinates
        return Tuple.Create(userLocation.Latitude, userLocation.Longitude, userLocation.Altitude ?? 0.0);
    }


    protected async void RunTimer()
    { // from https://stackoverflow.com/questions/72711306/what-is-the-best-way-to-use-periodictimer-for-refresh-component-in-blazor-server

        while (await _periodicTimer.WaitForNextTickAsync())
        {
            userLocation = await geoService.GetCurrentLocation();
            System.Diagnostics.Debug.WriteLine(geoService.GetCurrentLocation());
        }

    }


}
